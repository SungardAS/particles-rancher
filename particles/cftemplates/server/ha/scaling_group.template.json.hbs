---
frontload:
  amis:
    loader: rancheros
---
{{#layout}}

  {{#metadata logicalId="AWS::CloudFormation::Interface"}}
      "ParameterGroups" : [
        {
          "Label" : { "default" : "Rancher Server" },
          "Parameters" : [ "RancherServerImage" ]
        },
        {
          "Label" : { "default" : "AutoScaling" },
          "Parameters" : [ "DesiredCapacity", "MinSize", "MaxSize" ]
        },
        {
          "Label" : { "default" : "Network" },
          "Parameters" : [ "VpcId", "SubnetIds" ]
        },
        {
          "Label" : { "default":"EC2 Configuration" },
          "Parameters" : [ "OsVersion", "InstanceType", "VolumeSize", "KeyPairName", "InstanceProfileRole" ]
        },
        {
          "Label" : { "default":"DB Connection" },
          "Parameters" : [ "DBHost", "DBPort", "DBName", "DBUser", "DBPassword" ]
        }
      ]
  {{/metadata}}

  {{parameter "m:core" "base" type="String" logicalId="DBHost"}}
  {{parameter "m:rds" "db_instance/db_name" logicalId="DBName"}}
  {{parameter "m:core" "base" type="Number" logicalId="DBPort"}}
  {{parameter "m:core" "base" type="String" logicalId="DBUser"}}
  {{parameter "m:rds" "db_instance/password" logicalId="DBPassword"}}
  {{
    parameter "m:core" "base"
    type="AWS::EC2::SecurityGroup::Id"
    logicalId="DBSecurityGroup"
    description="If selected this group will be modified to allow connections from the RancherServer security group"
    optional=true
  }}
  {{
    condition "m:core" "is_populated"
    logicalId="DBSecurityGroupIsPopulated"
    parameterLogicalId="DBSecurityGroup"
  }}

  {{set "server/parameters_rancheros"}}
  {{set "server/parameters_scaling_group" vpcId=(ref "VpcId")}}

  {{#with amis}}
    {{mapping "rancheros_versions" logicalId="RancherVersionMap"}}
  {{/with}}


  {{
    set "server/ha/resources_scaling_group"
    cattleHostLabels=(ref "CattleHostLabels")
    cattleDbCattleMysqlHost=(ref "DBHost")
    cattleDbCattleMysqlName=(ref "DBName")
    cattleDbCattleMysqlPort=(ref "DBPort")
    cattleDbCattlePassword=(ref "DBPassword")
    cattleDbCattleUsername=(ref "DBUser")
    desiredCapacity=(ref "DesiredCapacity")
    imageId=(fnFindInMap "RancherVersionMap" (ref "OsVersion") "ami")
    instanceType=(ref "InstanceType")
    keyName=(ref "KeyPairName")
    launchConfigurationName=(ref "LaunchConfiguration")
    maxSize=(ref "MaxSize")
    minSize=(ref "MinSize")
    rancherAgentImage=(ref "RancherAgentImage")
    rancherRegistrationUrl=(ref "RancherRegistrationUrl")
    rancherServerImage=(ref "RancherServerImage")
    securityGroups=(arrayify (ref "SecurityGroup") )
    signalCount=(ref "DesiredCapacity")
    userData=(
      partial "userdata/rancheros"
      dockerVersion=(fnFindInMap "RancherVersionMap" (ref "OsVersion") "dockerVersion")
      resizeDevCondition="Is050Condition"
      resizeServiceCondition="Is050Condition"
      metadataResource="LaunchConfiguration"
      notifyResource="AutoScaleGroup"
    )
    volumeSize=(ref "VolumeSize")
    vpcZoneIdentifier=(ref "SubnetIds")
    vpcId=(ref "VpcId")
  }}

  {{
    resource "m:core" "spec"
    type="AWS::EC2::SecurityGroupIngress"
    logicalId="RancherServerDBAccess"
    condition="DBSecurityGroupIsPopulated"
    GroupId=(ref "SecurityGroup")
    FromPort=(ref "DBPort")
    ToPort=(ref "DBPort")
    IpProtocol="tcp"
  }}



{{/layout}}
