---
LBPortMappings:
  -
    source: 80
    dest: 8080
  -
    source: 443
    dest: 8080
---
{{#layout}}

  {{!-- Infra Params --}}

  {{
    parameter "m:core" "base"
    logicalId="VpcId"
    type="AWS::EC2::VPC::Id"
  }}

  {{
    parameter "m:core" "base"
    logicalId="SubnetIds"
    type="List<AWS::EC2::Subnet::Id>"
  }}


  {{!-- MySQL Resources --}}
  {{
    parameter "m:core" "base"
    logicalId="MySQLUser"
    type="String"
    default="condensation"
  }}

  {{
    parameter "m:core" "base"
    logicalId="MySQLPassword"
    noEcho=true
    type="String"
  }}

  {{
    parameter "m:core" "base"
    logicalId="MySQLHost"
    type="String"
  }}

  {{
    parameter "m:core" "base"
    logicalId="MySQLPort"
    type="Number"
    default=3306
  }}

  {{
    parameter "m:core" "base"
    logicalId="MySQLName"
    type="String"
  }}

  {{
    parameter "m:core" "base"
    logicalId="MySQLSecurityGroupId"
    type="AWS::EC2::SecurityGroup::Id"
  }}

  {{#resource logicalId="MySQLSecurityGroupIngress"}}
    "Type": "AWS::EC2::SecurityGroupIngress",
    "Properties": {
      "GroupId": {"Ref": "MySQLSecurityGroupId"},
      "SourceSecurityGroupId": {"Ref": "AppSecurityGroup"},
      "FromPort": {"Ref": "MySQLPort"},
      "ToPort": {"Ref": "MySQLPort"},
      "IpProtocol": "tcp"
    }
  {{/resource}}


  {{!-- Redis Resources --}}

  {{
    parameter "m:core" "base"
    logicalId="RedisHost"
    type="String"
  }}

  {{
    parameter "m:core" "base"
    logicalId="RedisPort"
    type="Number"
    default=6379
  }}

  {{
    parameter "m:core" "base"
    logicalId="RedisSecurityGroupId"
    type="AWS::EC2::SecurityGroup::Id"
  }}

  {{#resource logicalId="CacheSecurityGroupIngress"}}
    "Type": "AWS::EC2::SecurityGroupIngress",
    "Properties": {
      "GroupId": {"Ref": "RedisSecurityGroupId"},
      "IpProtocol": "tcp",
      "SourceSecurityGroupId": {"Ref": "AppSecurityGroup"},
      "FromPort": {"Ref": "RedisPort"},
      "ToPort": {"Ref": "RedisPort"}
    }
  {{/resource}}

  {{!-- App Resources --}}

  {{!
    parameter "m:core" "base"
    logicalId="IamInstanceProfile"
    type="String"
  }}

  {{
    parameter "m:core" "base"
    logicalId="ExhibitorUrl"
    type="String"
  }}

  {{
    parameter "m:core" "base"
    logicalId="ZookeeperClientSecurityGroup"
    type="AWS::EC2::SecurityGroup::Id"
  }}

  {{
    parameter "m:core" "base"
    logicalId="AppInstanceType"
    type="String"
    default="t2.medium"
  }}

  {{
    parameter "m:core" "base"
    logicalId="AppDockerImage"
    type="String"
    default="rancher/server:latest"
  }}

  {{
    parameter "m:core" "base"
    logicalId="AppClusterSize"
    type="String"
    default="3"
  }}

  {{
    parameter "m:core" "base"
    logicalId="KeyName"
    type="String"
  }}

  {{#condition logicalId="HasKeyName"}}
    "Fn::Not" : [{
      "Fn::Equals" : [{"Ref" : "KeyName"}, ""]
    }]
  {{/condition}}

  {{#resource logicalId="LBSecurityGroup"}}
    "Type": "AWS::EC2::SecurityGroup",
    "Properties": {
      "GroupDescription": "Rancher API Load Balancer",
      "VpcId": {"Ref": "VpcId"}
    }
  {{/resource}}

  {{#resource logicalId="AppSecurityGroup"}}
    "Type": "AWS::EC2::SecurityGroup",
    "Properties": {
      "GroupDescription": "Rancher API",
      "VpcId": {"Ref": "VpcId"}
    }
  {{/resource}}

  {{#each LBPortMappings}}
    {{#resource logicalId=(concat "LBSecurityGroupIngress" this.source)}}
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "CidrIp": "0.0.0.0/0",
        "FromPort": {{this.source}},
        "ToPort": {{this.source}},
        "IpProtocol": "tcp",
        "GroupId": {"Ref": "LBSecurityGroup"}
      },
      "DependsOn": "LBSecurityGroup"
    {{/resource}}
  {{/each}}

  {{#resource logicalId="AppSecurityGroupIngress"}}
    "Type": "AWS::EC2::SecurityGroupIngress",
    "Properties": {
      "FromPort": 8080,
      "ToPort": 8080,
      "IpProtocol": "tcp",
      "SourceSecurityGroupId": {"Ref": "LBSecurityGroup" },
      "GroupId": {"Ref": "AppSecurityGroup"}
    },
    "DependsOn": "AppSecurityGroup"
  {{/resource}}

  {{#resource "ha/load_balancer" logicalId="LoadBalancer"}}
    "Properties": {
      "SecurityGroups": [ {"Ref": "LBSecurityGroup"} ],
      "Subnets": {"Ref": "SubnetIds"},
      "Scheme": "internet-facing"
    }
  {{/resource}}

  {{#resource "ha/load_balancer" logicalId="WsLoadBalancer"}}
    "Properties": {
      "SecurityGroups": [ {"Ref": "LBSecurityGroup"} ],
      "Subnets": {"Ref": "SubnetIds"},
      "Scheme": "internet-facing"
    }
  {{/resource}}

  {{#resource "ha/load_balancer" logicalId="LoadBalancerInternal"}}
    "Properties": {
      "SecurityGroups": [ {"Ref": "LBSecurityGroup"} ],
      "Subnets": {"Ref": "SubnetIds"},
      "Scheme": "internal"
    }
  {{/resource}}

  {{#resource logicalId="LaunchConfig"}}
    "Type" : "AWS::AutoScaling::LaunchConfiguration",
    "Metadata" : {
      "AWS::CloudFormation::Init" : {
        "configSets": {
          "default": ["enableEpel","basePackages","runApp"]
        },
        "enableEpel": {
          "commands": {
            "001": {
              "command": "yum-config-manager --enable epel"
            }
          }
        },
        "basePackages": {
          "packages": {
            "yum": {
              "docker": []
            }
          },
          "services": {
            "sysvinit" : {
              "docker" : {
                "enabled" : "true",
                "ensureRunning" : "true"
              }
            }
          }
        },
        "runApp": {
          "files": {
            "/usr/local/bin/zk-list-nodes": {
              "content": { "Fn::Join": ["", [
                "#!/bin/bash -e\n",
                "curl -s \{{zk_discovery_url}} | python -c '",
                  "import sys, json;",
                  "j=json.load(sys.stdin);",
                  "servers=[\":\".join([s, str(j[\"port\"])]) for s in j[\"servers\"]];",
                  "print \",\".join(servers)'"
              ]]},
              "context": {
                "zk_discovery_url": {"Fn::Join" : ["", [ { "Ref": "ExhibitorUrl"} ]] }
              },
              "mode": "000755",
              "owner": "root",
              "group": "root"
            }
          },
          "commands": {
            "001": {
              "command": {{
                partial "rancher_server_command"
                cattleHostApiProxyMode="ha"
                defaultCattleMachineExecute=false
                cattleZookeeperConnectionString="`/usr/local/bin/zk-list-nodes`"
                cattleHostApiProxyHost='{"Fn::GetAtt": ["WsLoadBalancer", "DNSName"]}'
                cattleDbCattleMysqlName=(ref "MySQLName")
                cattleDbCattleUsername=(ref "MySQLUser")
                cattleDbCattlePassword=(ref "MySQLPassword")
                cattleDbCattleMysqlHost=(ref "MySQLHost")
                cattleDbCattleMysqlPort=(ref "MySQLPort")
                cattleRedisHosts=(ref "RedisHost")
                cattleRedisPort=(ref "RedisPort")
                rancherServerImage=(ref "AppDockerImage")
              }}
            }
          }
        }
      }
    },
    "Properties": {
      "ImageId": "{{helper "m:amazon-ami" "region-ami" "amzn-ami-hvm-2016.03.0.x86_64-gp2" }}",
      {{!"IamInstanceProfile": {"Ref": "IamInstanceProfile"},}}
      "KeyName": {
        "Fn::If" : [
          "HasKeyName",
          {"Ref" : "KeyName"},
          {"Ref" : "AWS::NoValue"}
        ]
      },
      "SecurityGroups": [ {"Ref": "AppSecurityGroup"}, {"Ref": "ZookeeperClientSecurityGroup"} ],
      "AssociatePublicIpAddress": "true",
      "InstanceType": {"Ref": "AppInstanceType" },
      "BlockDeviceMappings": [ { "DeviceName": "/dev/xvda", "Ebs": { "VolumeSize": "8" } } ],
      "UserData": {{
        partial "userdata/rancheros"
        metadataResource="LaunchConfig"
        notifyResource="AppInstanceGroup"
      }}
    }
  {{/resource}}

  {{#resource logicalId="WsLaunchConfig"}}
    "Type" : "AWS::AutoScaling::LaunchConfiguration",
    "Metadata" : {
      "AWS::CloudFormation::Init" : {
        "configSets": {
          "default": ["enableEpel","basePackages","runApp"]
        },
        "enableEpel": {
          "commands": {
            "001": {
              "command": "yum-config-manager --enable epel"
            }
          }
        },
        "basePackages": {
          "packages": {
            "yum": {
              "docker": []
            }
          },
          "services": {
            "sysvinit" : {
              "docker" : {
                "enabled" : "true",
                "ensureRunning" : "true"
              }
            }
          }
        },
        "runApp": {
          "files": {
            "/usr/local/bin/zk-list-nodes": {
              "content": { "Fn::Join": ["", [
                "#!/bin/bash -e\n",
                "curl -s \{{zk_discovery_url}} | python -c '",
                  "import sys, json;",
                  "j=json.load(sys.stdin);",
                  "servers=[\":\".join([s, str(j[\"port\"])]) for s in j[\"servers\"]];",
                  "print \",\".join(servers)'"
              ]]},
              "context": {
                "zk_discovery_url": {"Fn::Join" : ["", [ { "Ref": "ExhibitorUrl"} ]] }
              },
              "mode": "000755",
              "owner": "root",
              "group": "root"
            }
          },
          "commands": {
            "001": {
              "command": { "Fn::Join": ["", [
                "until `curl -X GET -O http://", {"Fn::GetAtt": ["LoadBalancerInternal", "DNSName"]}, "/v1/scripts/api.crt`; do sleep 1; done"
              ]]},
              "cwd": "/root"
            },
            "002": {
              "command": { "Fn::Join" : ["", [
                "/usr/bin/docker run -d ",
                "   --restart=on-failure",
                "   -p 8080:8080",
                "   -v /root/api.crt:/api.crt",
                "   rancher/server websocket-proxy -jwt-public-key-file=/api.crt -listen-address=0.0.0.0:8080"
              ]]}
            },
            "003": {
              "command": { "Fn::Join" : ["", [
                "/usr/bin/docker run -d ",
                "   --restart=on-failure",
                "   -e 'AWS_REGION=", {"Ref": "AWS::Region"}, "'",
                "   -e 'CATTLE_HOST_API_PROXY_MODE=ha'",
                "   -e 'DEFAULT_CATTLE_MACHINE_EXECUTE=true'",
                "   -e CATTLE_ZOOKEEPER_CONNECTION_STRING=`/usr/local/bin/zk-list-nodes`",
                "   -e 'CATTLE_HOST_API_PROXY_HOST=", {"Fn::GetAtt": ["WsLoadBalancer", "DNSName"]}, "'",
                "   -e 'CATTLE_DB_CATTLE_MYSQL_NAME=", {"Ref": "MySQLName" }, "'",
                "   -e 'CATTLE_DB_CATTLE_USERNAME=", {"Ref": "MySQLUser" }, "'",
                "   -e 'CATTLE_DB_CATTLE_PASSWORD=", {"Ref": "MySQLPassword" }, "'",
                "   -e 'CATTLE_DB_CATTLE_MYSQL_HOST=", {"Ref": "MySQLHost" }, "'",
                "   -e 'CATTLE_DB_CATTLE_MYSQL_PORT=", {"Ref": "MySQLPort" }, "'",
                "   -e 'CATTLE_REDIS_HOSTS=", {"Ref": "RedisHost" }, "'",
                "   -e 'CATTLE_REDIS_PORT=", {"Ref": "RedisPort" }, "'",
                "   ", { "Ref": "AppDockerImage" }
              ]]}
            }
          }
        }
      }
    },
    "Properties": {
      "ImageId": "{{helper "m:amazon-ami" "region-ami" "amzn-ami-hvm-2016.03.0.x86_64-gp2" }}",
      {{!"IamInstanceProfile": {"Ref": "IamInstanceProfile"},}}
      "KeyName": {
        "Fn::If" : [
          "HasKeyName",
          {"Ref" : "KeyName"},
          {"Ref" : "AWS::NoValue"}
        ]
      },
      "SecurityGroups": [ { "Ref" : "AppSecurityGroup" }, {"Ref": "ZookeeperClientSecurityGroup"} ],
      "AssociatePublicIpAddress": "true",
      "InstanceType": {"Ref": "AppInstanceType" },
      "BlockDeviceMappings": [ { "DeviceName": "/dev/xvda", "Ebs": { "VolumeSize": "8" } } ],
      "UserData": {{
        partial "userdata/rancheros"
        metadataResource="WsLaunchConfig"
        notifyResource="WsInstanceGroup"
      }}
    }
  {{/resource}}


  {{#resource logicalId="AppInstanceGroup"}}
    "Type": "AWS::AutoScaling::AutoScalingGroup",
    "Properties": {
      "AvailabilityZones": { "Fn::GetAZs": "AWS::Region" },
      "LaunchConfigurationName" : { "Ref" : "LaunchConfig" },
      "MinSize" : "1",
      "MaxSize" : "9",
      "DesiredCapacity" : { "Ref": "AppClusterSize" },
      "LoadBalancerNames" : [ {"Ref": "LoadBalancer" },{ "Ref": "LoadBalancerInternal" } ],
      "VPCZoneIdentifier" : { "Ref": "SubnetIds" },
      "HealthCheckGracePeriod": 90
    },
    "CreationPolicy": {
      "ResourceSignal": {
        "Count": {"Ref": "AppClusterSize"},
        "Timeout": "PT15M"
      }
    },
    "UpdatePolicy": {
      "AutoScalingRollingUpdate": {
        "PauseTime": "PT15M",
        "MaxBatchSize": 2,
        "MinInstancesInService": 1,
        "WaitOnResourceSignals": true
      }
    },
    "DependsOn": ["WsLoadBalancer"]
  {{/resource}}

  {{#resource logicalId="WsInstanceGroup"}}
    "Type": "AWS::AutoScaling::AutoScalingGroup",
    "Properties": {
      "AvailabilityZones": { "Fn::GetAZs": "AWS::Region" },
      "LaunchConfigurationName" : { "Ref" : "WsLaunchConfig" },
      "MinSize" : "1",
      "MaxSize" : "1",
      "DesiredCapacity": 1,
      "LoadBalancerNames": [ {"Ref": "WsLoadBalancer" }],
      "VPCZoneIdentifier": { "Ref" : "SubnetIds" },
      "HealthCheckGracePeriod": 90
    },
    "CreationPolicy": {
      "ResourceSignal": {
        "Count": 1,
        "Timeout": "PT15M"
      }
    },
    "UpdatePolicy": {
      "AutoScalingRollingUpdate": {
        "PauseTime": "PT15M",
        "MaxBatchSize": 2,
        "MinInstancesInService": 1,
        "WaitOnResourceSignals": true
      }
    },
    "DependsOn": "AppInstanceGroup"
  {{/resource}}

  {{#output logicalId="LoadBalancerDNSName"}}
    "Value": {"Fn::GetAtt" : [ "LoadBalancer", "DNSName" ]}
  {{/output}}

  {{#output logicalId="AppSecurityGroupId"}}
    "Value": {"Ref": "AppSecurityGroup"}
  {{/output}}

  {{#output logicalId="LBSecurityGroupId"}}
    "Value": {"Ref": "LBSecurityGroup"}
  {{/output}}


{{/layout}}
